<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Busca - Vintélo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .search-container {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        .search-input {
            width: 70%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .search-btn {
            padding: 10px 20px;
            background: #7d2838;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>Teste de Funcionalidade de Busca</h1>
    
    <div class="search-container">
        <h2>Testar Busca</h2>
        <input type="text" id="searchInput" class="search-input" placeholder="Digite um termo para buscar..." value="vestido">
        <button onclick="testarBusca()" class="search-btn">Buscar</button>
        
        <div style="margin-top: 15px;">
            <button onclick="testarBusca('vestido')" style="margin: 5px; padding: 5px 10px;">vestido</button>
            <button onclick="testarBusca('blusa')" style="margin: 5px; padding: 5px 10px;">blusa</button>
            <button onclick="testarBusca('brechó')" style="margin: 5px; padding: 5px 10px;">brechó</button>
            <button onclick="testarBusca('maria')" style="margin: 5px; padding: 5px 10px;">maria</button>
        </div>
    </div>
    
    <div id="results" class="results">
        <p>Clique em "Buscar" para testar a funcionalidade...</p>
    </div>

    <script>
        async function testarBusca(termo) {
            const input = document.getElementById('searchInput');
            const results = document.getElementById('results');
            
            if (termo) {
                input.value = termo;
            } else {
                termo = input.value.trim();
            }
            
            if (!termo) {
                results.innerHTML = '<div class="status error">Digite um termo para buscar!</div>';
                return;
            }
            
            results.innerHTML = '<div class="status info">Buscando por: "' + termo + '"...</div>';
            
            try {
                // Testar endpoint da API
                const response = await fetch(`/api/buscar?q=${encodeURIComponent(termo)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                let html = '<div class="status success">Busca realizada com sucesso!</div>';
                html += '<h3>Resultados:</h3>';
                html += `<p><strong>Produtos encontrados:</strong> ${data.produtos ? data.produtos.length : 0}</p>`;
                html += `<p><strong>Brechós encontrados:</strong> ${data.brechos ? data.brechos.length : 0}</p>`;
                
                if (data.produtos && data.produtos.length > 0) {
                    html += '<h4>Produtos:</h4><ul>';
                    data.produtos.forEach(produto => {
                        html += `<li>${produto.NOME_PRODUTO} - R$ ${produto.PRECO} (${produto.VENDEDOR})</li>`;
                    });
                    html += '</ul>';
                }
                
                if (data.brechos && data.brechos.length > 0) {
                    html += '<h4>Brechós:</h4><ul>';
                    data.brechos.forEach(brecho => {
                        html += `<li>${brecho.NOME_USUARIO} (${brecho.total_produtos} produtos)</li>`;
                    });
                    html += '</ul>';
                }
                
                if ((!data.produtos || data.produtos.length === 0) && (!data.brechos || data.brechos.length === 0)) {
                    html += '<div class="status info">Nenhum resultado encontrado para "' + termo + '"</div>';
                }
                
                results.innerHTML = html;
                
            } catch (error) {
                console.error('Erro na busca:', error);
                results.innerHTML = `
                    <div class="status error">
                        <strong>Erro ao realizar busca:</strong><br>
                        ${error.message}<br><br>
                        <em>Isso pode indicar que o servidor não está rodando ou há um problema na conexão com o banco de dados.</em>
                    </div>
                `;
            }
        }
        
        // Permitir busca com Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testarBusca();
            }
        });
        
        // Testar conexão ao carregar a página
        window.addEventListener('load', function() {
            fetch('/api/buscar?q=teste')
                .then(response => {
                    if (response.ok) {
                        document.getElementById('results').innerHTML = '<div class="status success">Servidor conectado! Pronto para testar a busca.</div>';
                    } else {
                        throw new Error('Servidor não respondeu corretamente');
                    }
                })
                .catch(error => {
                    document.getElementById('results').innerHTML = '<div class="status error">Servidor não está respondendo. Verifique se o servidor está rodando.</div>';
                });
        });
    </script>
</body>
</html>